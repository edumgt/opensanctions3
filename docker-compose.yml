version: "3.9"

networks:
  appnet:
    driver: bridge

services:
  zavod:
    image: ghcr.io/opensanctions/opensanctions:latest
    env_file:
      - .env
    volumes:
      - .:/opensanctions
    networks:
      - appnet
    command: >
      bash -c "
        echo 'ðŸš€ Scanning datasets (excluding _ folders, GCS-dependent, ru_nsd_isin, and cz_business_register)...' &&
        FAILED_FILE=/opensanctions/failed_datasets.md &&
        echo '# âŒ Failed Datasets (Zavod Batch Run)' > $$FAILED_FILE &&
        echo '' >> $$FAILED_FILE &&

        for file in $(find /opensanctions/datasets -type f -name '*.yml' ! -path '*/_*/*'); do
          BASENAME=$(basename $$file)
          
          # âœ… íŠ¹ì • dataset ì œì™¸ (ru_nsd_isin.yml, cz_business_register.yml, us_corpwatch.yml)
          if [[ $$BASENAME == 'ru_nsd_isin.yml' || $$BASENAME == 'cz_business_register.yml' || $$BASENAME == 'us_corpwatch.yml' || $$BASENAME == 'lv_business_register.yml' || $$BASENAME == 'lv_business_register.yml' || $$BASENAME == 'md_companies.yml' ]]; then
            echo 'ðŸš« Skipping excluded dataset: '$$file;
            continue;
          fi

          # âš ï¸ ë‚´ë¶€ ë°ì´í„°(GCS) ì˜ì¡´ì„± ê²€ì‚¬
          if grep -q 'fetch_internal_data' $$file; then
            echo 'âš ï¸  Skipping GCS-dependent dataset: '$$file;
            continue;
          fi

          echo 'âš™ï¸  Running ETL for: '$$file;
          (zavod crawl $$file && zavod export $$file && zavod load-db $$file);

          if [ $$? -eq 0 ]; then
            echo 'âœ… Completed: '$$file;
          else
            echo 'âŒ Failed: '$$file;
            echo '- '$$file >> $$FAILED_FILE;
          fi
        done &&

        echo '' >> $$FAILED_FILE &&
        echo '---' >> $$FAILED_FILE &&
        echo 'ðŸ•’ Run completed on: '$(date) >> $$FAILED_FILE &&

        echo 'ðŸŽ‰ All datasets processed. Failures logged in failed_datasets.md (host directory)'
      "
