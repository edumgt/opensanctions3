version: "3.9"

networks:
  appnet:           
    driver: bridge

services:
  db:
    image: postgres:15
    container_name: opensanctions-db
    environment:
      POSTGRES_DB: dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    networks:
      - appnet
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres", "-d", "dev"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - ./postgres-data:/var/lib/postgresql/data

  zavod:
    image: ghcr.io/opensanctions/opensanctions:latest
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - .env
    volumes:
      - .:/opensanctions   # âœ… ë¡œì»¬ ìœˆë„ìš° ê²½ë¡œì™€ ë§¤í•‘ë¨
    networks:
      - appnet
    command: >
      bash -c "
        echo 'ðŸš€ Scanning datasets (excluding _ folders & GCS-dependent)...' &&
        FAILED_FILE=/opensanctions/failed_datasets.md &&
        echo '# âŒ Failed Datasets (Zavod Batch Run)' > $$FAILED_FILE &&
        echo '' >> $$FAILED_FILE &&

        for file in $(find /opensanctions/datasets -type f -name '*.yml' ! -path '*/_*/*'); do
          # ë‚´ë¶€ ë°ì´í„°(GCS) ì˜ì¡´ì„± ê²€ì‚¬
          if grep -q 'fetch_internal_data' $$file; then
            echo 'âš ï¸  Skipping GCS-dependent dataset: '$$file;
            continue;
          fi

          echo 'âš™ï¸  Running ETL for: '$$file;
          (zavod crawl $$file && zavod export $$file && zavod load-db $$file);

          if [ $$? -eq 0 ]; then
            echo 'âœ… Completed: '$$file;
          else
            echo 'âŒ Failed: '$$file;
            echo '- '$$file >> $$FAILED_FILE;
          fi
        done &&

        echo '' >> $$FAILED_FILE &&
        echo '---' >> $$FAILED_FILE &&
        echo 'ðŸ•’ Run completed on: '$(date) >> $$FAILED_FILE &&

        echo 'ðŸŽ‰ All datasets processed. Failures logged in failed_datasets.md (host directory)'
      "

  web:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: zavod-ui
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "80:3000"
    networks:
      - appnet
    environment:
      ZAVOD_DATABASE_URI: postgresql://postgres:password@db:5432/dev
      ZAVOD_ALLOW_UNAUTHENTICATED: "true"
      LANG: en_US.UTF-8
      TZ: UTC
    working_dir: /app
    command: npm run start
